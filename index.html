<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Wawancara Otomatis (Fixed)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .section { display: none; }
        .active { display: block; }
        .question-card { margin-bottom: 20px; border-left: 4px solid #0d6efd; }
        .recording-indicator { display: none; color: #dc3545; font-weight: bold; }
        .recording { display: inline-block; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1 } 50% { opacity: 0.5 } 100% { opacity: 1 } }
        .progress { height: 10px; }
        .audio-player { width: 100%; margin: 10px 0; }
        .upload-status { display: none; margin-top: 10px; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white text-center">
                        <h2 class="mb-0">Aplikasi Wawancara Otomatis</h2>
                    </div>
                    <div class="card-body p-4">
                        <!-- Section 1: Biodata -->
                        <div id="section1" class="section active">
                            <h3 class="mb-4">Data Diri</h3>
                            <form id="biodataForm">
                                <div class="mb-3">
                                    <label for="nama" class="form-label">Nama Lengkap</label>
                                    <input type="text" class="form-control" id="nama" required>
                                </div>
                                <div class="mb-3">
                                    <label for="npp" class="form-label">NPP</label>
                                    <input type="text" class="form-control" id="npp" required>
                                </div>
                                <div class="mb-4">
                                    <label for="divisi" class="form-label">Divisi</label>
                                    <select class="form-select" id="divisi" required>
                                        <option value="" selected disabled>Pilih Divisi</option>
                                        <option value="IT">IT</option>
                                        <option value="HR">HR</option>
                                        <option value="Finance">Finance</option>
                                        <option value="Marketing">Marketing</option>
                                        <option value="Operations">Operations</option>
                                    </select>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">Mulai Wawancara</button>
                                </div>
                            </form>
                        </div>

                        <!-- Section 2: Wawancara -->
                        <div id="section2" class="section">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h3>Wawancara</h3>
                                <div class="text-muted">
                                    Pertanyaan: <span id="currentQuestion">1</span>/<span id="totalQuestions">5</span>
                                </div>
                            </div>
                            
                            <div class="progress mb-4">
                                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            
                            <div class="card question-card">
                                <div class="card-body">
                                    <h5 id="questionTitle" class="card-title">Pertanyaan 1</h5>
                                    <audio id="questionAudio" class="audio-player" controls>
                                        Browser Anda tidak mendukung elemen audio.
                                    </audio>
                                    <div class="mt-3">
                                        <p class="mb-2">Rekam jawaban Anda:</p>
                                        <div class="d-flex flex-column flex-md-row gap-2 align-items-md-center">
                                            <button id="startRecord" class="btn btn-outline-danger">
                                                <i class="bi bi-record-circle"></i> Mulai Rekam
                                            </button>
                                            <button id="stopRecord" class="btn btn-outline-secondary" disabled>
                                                <i class="bi bi-stop-circle"></i> Stop Rekam
                                            </button>
                                            <span id="recordingIndicator" class="recording-indicator">
                                                <i class="bi bi-record-circle recording"></i> Sedang Merekam...
                                            </span>
                                            <span id="timer" class="ms-md-auto">00:00</span>
                                        </div>
                                        <audio id="answerAudio" class="audio-player mt-3" controls style="display: none;">
                                            Browser Anda tidak mendukung elemen audio.
                                        </audio>
                                        <div id="uploadStatus" class="upload-status">
                                            <small class="text-success"><i class="bi bi-check-circle"></i> Jawaban berhasil disimpan</small>
                                        </div>
                                        <div id="uploadDebug" class="mt-2" style="font-size:0.9rem;color:#666"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button id="prevQuestion" class="btn btn-outline-secondary" disabled>
                                    <i class="bi bi-arrow-left"></i> Sebelumnya
                                </button>
                                <button id="nextQuestion" class="btn btn-primary">
                                    Selanjutnya <i class="bi bi-arrow-right"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Section 3: Selesai -->
                        <div id="section3" class="section text-center">
                            <div class="py-4">
                                <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                                <h3 class="my-3">Wawancara Selesai!</h3>
                                <p class="lead">Terima kasih telah mengikuti sesi wawancara.</p>
                                <p>Jawaban Anda sedang diunggah ke Google Drive...</p>
                                <div id="uploadProgress" class="progress mb-3" style="display: none;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                                </div>
                                <div id="finalStatus" class="mt-3"></div>
                                <button id="restartInterview" class="btn btn-primary mt-3">
                                    <i class="bi bi-arrow-repeat"></i> Mulai Wawancara Baru
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Konfigurasi aplikasi
        const CONFIG = {
            totalQuestions: 5,
            googleDriveFolderId: '1K4I99O11EO4wYzSPzp6LwpAdSjwj-X43', // Ganti dengan ID folder Google Drive Anda
            googleScriptUrl: 'https://script.google.com/macros/s/AKfycbxQRp7poB8QysD88vVoycdl1DqO0VtWDQLfecrhZVWKA2Ok-CGJ7nTxTcHORpzk9k9S/exec' // Ganti dengan URL Google Apps Script Anda
        };

        // State aplikasi
        let state = {
            currentQuestion: 1,
            answers: {},
            audioBlobs: {},
            mediaRecorder: null,
            audioChunks: [],
            isRecording: false,
            recordingTime: 0,
            timerInterval: null,
            biodata: {}
        };

        // Elemen DOM
        const section1 = document.getElementById('section1');
        const section2 = document.getElementById('section2');
        const section3 = document.getElementById('section3');
        const biodataForm = document.getElementById('biodataForm');
        const currentQuestionEl = document.getElementById('currentQuestion');
        const totalQuestionsEl = document.getElementById('totalQuestions');
        const progressBar = document.getElementById('progressBar');
        const questionTitle = document.getElementById('questionTitle');
        const questionAudio = document.getElementById('questionAudio');
        const answerAudio = document.getElementById('answerAudio');
        const startRecordBtn = document.getElementById('startRecord');
        const stopRecordBtn = document.getElementById('stopRecord');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const timerEl = document.getElementById('timer');
        const prevQuestionBtn = document.getElementById('prevQuestion');
        const nextQuestionBtn = document.getElementById('nextQuestion');
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadDebug = document.getElementById('uploadDebug');
        const uploadProgress = document.getElementById('uploadProgress');
        const finalStatus = document.getElementById('finalStatus');
        const restartInterviewBtn = document.getElementById('restartInterview');

        // Inisialisasi aplikasi
        function initApp() {
            totalQuestionsEl.textContent = CONFIG.totalQuestions;
            updateProgressBar();
            loadQuestion();
            
            // Event listeners
            biodataForm.addEventListener('submit', handleBiodataSubmit);
            startRecordBtn.addEventListener('click', startRecording);
            stopRecordBtn.addEventListener('click', stopRecording);
            prevQuestionBtn.addEventListener('click', goToPreviousQuestion);
            nextQuestionBtn.addEventListener('click', goToNextQuestion);
            restartInterviewBtn.addEventListener('click', restartInterview);
        }

        // Handle submit biodata
        function handleBiodataSubmit(e) {
            e.preventDefault();
            
            state.biodata = {
                nama: document.getElementById('nama').value.trim(),
                npp: document.getElementById('npp').value.trim(),
                divisi: document.getElementById('divisi').value
            };
            
            if (!state.biodata.nama || !state.biodata.npp) {
                alert('Isi nama dan NPP terlebih dahulu');
                return;
            }

            // Simpan ke localStorage untuk backup
            localStorage.setItem('biodata', JSON.stringify(state.biodata));
            
            // Pindah ke section wawancara
            showSection(section2);
        }

        // Tampilkan section tertentu
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            section.classList.add('active');
        }

        // Update progress bar
        function updateProgressBar() {
            const progress = ((state.currentQuestion - 1) / CONFIG.totalQuestions) * 100;
            progressBar.style.width = `${progress}%`;
            currentQuestionEl.textContent = state.currentQuestion;
        }

        // Muat pertanyaan
        function loadQuestion() {
            questionTitle.textContent = `Pertanyaan ${state.currentQuestion}`;
            questionAudio.src = `soal${state.currentQuestion}.mp3`;
            
            // Reset UI rekaman (tidak menghentikan rekaman yang sedang berlangsung)
            resetRecordingUI();
            
            // Tampilkan jawaban yang sudah direkam sebelumnya jika ada
            if (state.answers[state.currentQuestion]) {
                answerAudio.src = state.answers[state.currentQuestion];
                answerAudio.style.display = 'block';
                uploadStatus.style.display = 'block';
            }
            
            // Update status tombol navigasi
            prevQuestionBtn.disabled = state.currentQuestion === 1;
            nextQuestionBtn.textContent = state.currentQuestion === CONFIG.totalQuestions ? 
                'Selesai' : 'Selanjutnya <i class="bi bi-arrow-right"></i>';
        }

        // Reset UI rekaman (tidak memanggil stopRecording)
        function resetRecordingUI() {
            answerAudio.style.display = 'none';
            answerAudio.src = '';
            uploadStatus.style.display = 'none';
            uploadDebug.textContent = '';
            timerEl.textContent = '00:00';
            state.recordingTime = 0;
        }

        // Mulai rekaman
        async function startRecording() {
            try {
                if (state.isRecording) return;
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.mediaRecorder = new MediaRecorder(stream);
                state.audioChunks = [];

                state.mediaRecorder.ondataavailable = (event) => {
                    if (event.data && event.data.size > 0) {
                        state.audioChunks.push(event.data);
                    }
                };

                state.mediaRecorder.onstop = async () => {
                    try {
                        // Jika tidak ada data, beri tahu user
                        if (!state.audioChunks || state.audioChunks.length === 0) {
                            console.error('Audio kosong!');
                            uploadDebug.textContent = 'Rekaman kosong. Silakan rekam ulang.';
                            return;
                        }

                        const audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);

                        // Simpan jawaban di state
                        state.answers[state.currentQuestion] = audioUrl;
                        state.audioBlobs[state.currentQuestion] = audioBlob;

                        // Tampilkan audio
                        answerAudio.src = audioUrl;
                        answerAudio.style.display = 'block';

                        // Upload ke Google Drive (base64 method)
                        await uploadRecordingToDrive(state.currentQuestion, audioBlob);

                        // Hentikan semua track mic
                        stream.getTracks().forEach(track => track.stop());

                    } catch (err) {
                        console.error('onstop error', err);
                        uploadDebug.textContent = 'Terjadi kesalahan saat memproses rekaman.';
                    } finally {
                        state.isRecording = false;
                        startRecordBtn.disabled = false;
                        stopRecordBtn.disabled = true;
                        recordingIndicator.style.display = 'none';
                        stopTimer();
                    }
                };

                state.mediaRecorder.start();
                state.isRecording = true;

                // Update UI
                startRecordBtn.disabled = true;
                stopRecordBtn.disabled = false;
                recordingIndicator.style.display = 'inline';

                // Mulai timer
                startTimer();

            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Tidak dapat mengakses mikrofon. Pastikan Anda memberikan izin akses mikrofon.');
            }
        }

        // Hentikan rekaman (dipanggil hanya oleh tombol Stop)
        function stopRecording() {
            if (state.mediaRecorder && state.isRecording) {
                // onstop handler akan men-handle sisa cleanup dan upload
                state.mediaRecorder.stop();
                // jangan set state.isRecording = false di sini — tunggu onstop selesai
                startRecordBtn.disabled = false;
                stopRecordBtn.disabled = true;
            }
        }

        // Upload rekaman ke Google Drive (menggunakan base64 untuk kestabilan)
        async function uploadRecordingToDrive(questionNumber, audioBlob) {
            try {
                uploadDebug.textContent = 'Mengunggah...';
                // Konversi blob → base64 (tanpa data:prefix)
                const base64Audio = await blobToBase64(audioBlob);

                const body = {
                    folderId: CONFIG.googleDriveFolderId,
                    nama: state.biodata.nama,
                    npp: state.biodata.npp,
                    divisi: state.biodata.divisi,
                    question: questionNumber,
                    filename: `jawaban_${questionNumber}.webm`,
                    audioBase64: base64Audio
                };

                const response = await fetch(CONFIG.googleScriptUrl, {
                    method: 'POST',
                    body: JSON.stringify(body),
                    headers: { 'Content-Type': 'application/json' }
                });

                // Jika response bukan JSON, ini akan throw
                const result = await response.json();

                if (result.status === 'success') {
                    uploadStatus.style.display = 'block';
                    uploadDebug.textContent = `Upload sukses: ${result.fileName} (id: ${result.fileId})`;
                } else {
                    throw new Error(result.message || 'Unknown error from server');
                }

            } catch (error) {
                console.error('Error uploading recording:', error);
                uploadStatus.innerHTML = '<small class="text-danger"><i class="bi bi-exclamation-circle"></i> Gagal mengupload jawaban</small>';
                uploadStatus.style.display = 'block';
                uploadDebug.textContent = error.message || String(error);
            }
        }

        // fungsi helper konversi blob → base64 string (tanpa prefix)
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    try {
                        const dataUrl = reader.result;
                        const base64 = dataUrl.split(',')[1];
                        resolve(base64);
                    } catch (e) { reject(e); }
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // Mulai timer
        function startTimer() {
            state.recordingTime = 0;
            updateTimerDisplay();
            state.timerInterval = setInterval(() => {
                state.recordingTime++;
                updateTimerDisplay();
            }, 1000);
        }

        // Hentikan timer
        function stopTimer() {
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
        }

        // Update tampilan timer
        function updateTimerDisplay() {
            const minutes = Math.floor(state.recordingTime / 60);
            const seconds = state.recordingTime % 60;
            timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Ke pertanyaan sebelumnya
        function goToPreviousQuestion() {
            if (state.isRecording) { alert('Silakan hentikan rekaman terlebih dahulu.'); return; }
            if (state.currentQuestion > 1) {
                state.currentQuestion--;
                updateProgressBar();
                loadQuestion();
            }
        }

        // Ke pertanyaan berikutnya
        function goToNextQuestion() {
            if (state.isRecording) { alert('Silakan hentikan rekaman terlebih dahulu.'); return; }
            if (state.currentQuestion < CONFIG.totalQuestions) {
                state.currentQuestion++;
                updateProgressBar();
                loadQuestion();
            } else {
                // Selesai wawancara
                finishInterview();
            }
        }

        // Selesaikan wawancara
        async function finishInterview() {
            showSection(section3);
            uploadProgress.style.display = 'block';
            
            try {
                // Verifikasi semua jawaban sudah direkam
                const unansweredQuestions = [];
                for (let i = 1; i <= CONFIG.totalQuestions; i++) {
                    if (!state.answers[i]) {
                        unansweredQuestions.push(i);
                    }
                }
                
                if (unansweredQuestions.length > 0) {
                    finalStatus.innerHTML = `
                        <div class="alert alert-warning">
                            <h6>Peringatan</h6>
                            <p>Beberapa pertanyaan belum dijawab: ${unansweredQuestions.join(', ')}</p>
                            <p>Jawaban yang sudah direkam telah disimpan di Google Drive (jika upload berhasil).</p>
                        </div>
                    `;
                } else {
                    finalStatus.innerHTML = `
                        <div class="alert alert-success">
                            <h6>Selamat!</h6>
                            <p>Semua jawaban telah berhasil disimpan di Google Drive.</p>
                            <p class="mb-0">Folder: <strong>${state.biodata.nama}-${state.biodata.npp}</strong></p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error finishing interview:', error);
                finalStatus.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>Terjadi Kesalahan</h6>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                uploadProgress.style.display = 'none';
            }
        }

        // Mulai ulang wawancara
        function restartInterview() {
            // Reset state
            state = {
                currentQuestion: 1,
                answers: {},
                audioBlobs: {},
                mediaRecorder: null,
                audioChunks: [],
                isRecording: false,
                recordingTime: 0,
                timerInterval: null,
                biodata: {}
            };
            
            // Reset form biodata
            biodataForm.reset();
            
            // Kembali ke section 1
            showSection(section1);
            
            // Reset progress bar
            updateProgressBar();
            
            // Reset status
            finalStatus.innerHTML = '';
        }

        // Jalankan aplikasi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
